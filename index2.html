<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PharmaChain — Anti-Counterfeit Supply Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=JetBrains+Mono:wght@300;400;500&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ============================================================
   PharmaChain — Complete Interface
   Palette: Deep slate navy · Ice white · Teal · Amber · Crimson
   Fonts:   Syne (display) + JetBrains Mono (data) + Barlow (body)
   Roles:   Manufacturer · Distributor · Pharmacy · Customer
   ============================================================ */

@import url('https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=JetBrains+Mono:wght@300;400;500&family=Barlow:wght@300;400;500;600&display=swap');

:root {
  --bg-void:        #080c12;
  --bg-base:        #0d1320;
  --bg-raised:      #111927;
  --bg-card:        #141e2e;
  --bg-input:       #0f1720;
  --bg-border:      #1e2d42;

  --text-primary:   #e8edf5;
  --text-secondary: #7d92aa;
  --text-dim:       #3d5166;
  --text-label:     #4e6680;

  --teal:           #1dd3b0;
  --teal-dim:       #0f7a66;
  --teal-glow:      rgba(29,211,176,0.12);
  --teal-border:    rgba(29,211,176,0.25);

  --amber:          #f0a500;
  --amber-dim:      #7a5200;
  --amber-glow:     rgba(240,165,0,0.10);
  --amber-border:   rgba(240,165,0,0.25);

  --crimson:        #e8365d;
  --crimson-dim:    #6e1a2c;
  --crimson-glow:   rgba(232,54,93,0.10);
  --crimson-border: rgba(232,54,93,0.25);

  --slate:          #4e8bcd;
  --slate-dim:      #253d5a;
  --slate-glow:     rgba(78,139,205,0.10);

  --violet:         #a78bfa;
  --violet-glow:    rgba(167,139,250,0.10);
  --violet-border:  rgba(167,139,250,0.25);

  --space-xs:  4px;
  --space-sm:  8px;
  --space-md:  16px;
  --space-lg:  24px;
  --space-xl:  40px;
  --space-2xl: 64px;

  --font-display: 'Syne', sans-serif;
  --font-mono:    'JetBrains Mono', monospace;
  --font-body:    'Barlow', sans-serif;

  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;

  --ease:   cubic-bezier(0.16,1,0.3,1);
  --t-fast: 150ms var(--ease);
  --t-mid:  280ms var(--ease);
  --t-slow: 500ms var(--ease);

  --header-h: 64px;
  --ticker-h: 36px;
}

/* ── RESET ── */
*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
html { font-size:15px; scroll-behavior:smooth; -webkit-font-smoothing:antialiased; }

body {
  background-color: var(--bg-void);
  color: var(--text-primary);
  font-family: var(--font-body);
  font-weight: 400;
  line-height: 1.6;
  min-height: 100vh;
  background-image:
    radial-gradient(ellipse 80% 50% at 50% -10%, rgba(29,211,176,0.05) 0%, transparent 70%),
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");
}

a { color:inherit; text-decoration:none; }
button,input,select,textarea { font-family:inherit; font-size:inherit; }
img { display:block; max-width:100%; }
.hidden { display:none !important; }
.mono { font-family:var(--font-mono); font-size:0.82rem; letter-spacing:0.02em; }
.small { font-size:0.8rem; color:var(--text-secondary); }

/* ── HEADER ── */
#site-header {
  position:sticky; top:0; z-index:100;
  height:var(--header-h);
  background:rgba(8,12,18,0.92);
  border-bottom:1px solid var(--bg-border);
  backdrop-filter:blur(16px);
  -webkit-backdrop-filter:blur(16px);
}
.header-inner {
  max-width:1280px; margin:0 auto;
  padding:0 var(--space-xl);
  height:100%; display:flex; align-items:center; gap:var(--space-xl);
}
.logo-block { display:flex; align-items:center; gap:var(--space-md); flex-shrink:0; }
.logo-icon {
  font-size:1.4rem; color:var(--teal); line-height:1;
  filter:drop-shadow(0 0 8px var(--teal));
  animation:pulse-glow 3s ease-in-out infinite;
}
@keyframes pulse-glow {
  0%,100%{ filter:drop-shadow(0 0 6px var(--teal)); opacity:.9; }
  50%    { filter:drop-shadow(0 0 14px var(--teal)); opacity:1; }
}
.logo-text { display:flex; flex-direction:column; gap:1px; }
.logo-main { font-family:var(--font-display); font-size:1.15rem; font-weight:800; letter-spacing:0.12em; color:var(--text-primary); line-height:1; }
.logo-sub  { font-family:var(--font-mono); font-size:0.6rem; letter-spacing:0.15em; color:var(--text-label); }

/* ── ROLE NAV ── */
#role-nav { display:flex; align-items:center; gap:2px; margin:0 auto; background:var(--bg-raised); border:1px solid var(--bg-border); border-radius:var(--radius-md); padding:3px; }
.role-btn {
  background:none; border:1px solid transparent;
  color:var(--text-secondary);
  font-family:var(--font-mono); font-size:0.68rem; font-weight:500; letter-spacing:0.1em;
  padding:7px 18px; border-radius:var(--radius-sm);
  cursor:pointer; transition:all var(--t-fast); white-space:nowrap;
  display:flex; align-items:center; gap:6px;
}
.role-btn:hover { color:var(--text-primary); background:var(--bg-card); }
.role-btn.active { color:var(--bg-void); background:var(--teal); border-color:var(--teal); font-weight:700; }

/* Role-specific active colours */
.role-btn[data-role="distributor"].active { background:var(--amber); border-color:var(--amber); }
.role-btn[data-role="pharmacy"].active    { background:var(--violet); border-color:var(--violet); }
.role-btn[data-role="customer"].active    { background:var(--slate); border-color:var(--slate); }

.role-icon { font-size:0.9rem; }

/* Chain status */
.chain-status { display:flex; align-items:center; gap:var(--space-sm); flex-shrink:0; }
.status-dot { width:7px; height:7px; border-radius:50%; background:var(--text-dim); transition:background var(--t-mid); }
.status-dot.dot-online  { background:var(--teal);   box-shadow:0 0 8px var(--teal);   animation:dot-pulse 2s ease-in-out infinite; }
.status-dot.dot-offline { background:var(--crimson); box-shadow:0 0 8px var(--crimson); }
@keyframes dot-pulse { 0%,100%{opacity:1;} 50%{opacity:.4;} }
#chain-label { font-family:var(--font-mono); font-size:0.68rem; letter-spacing:0.1em; color:var(--text-secondary); }

/* ── TICKER ── */
#ticker-bar {
  height:var(--ticker-h); background:var(--bg-base);
  border-bottom:1px solid var(--bg-border);
  display:flex; align-items:center; overflow:hidden;
}
.ticker-label {
  font-family:var(--font-mono); font-size:0.6rem; letter-spacing:0.15em; color:var(--teal);
  background:var(--teal-glow); border-right:1px solid var(--teal-border);
  padding:0 var(--space-md); height:100%; display:flex; align-items:center; flex-shrink:0;
}
.ticker-track {
  display:flex; align-items:center; gap:var(--space-2xl);
  padding-left:var(--space-xl); white-space:nowrap;
  animation:ticker-scroll 32s linear infinite;
}
.ticker-item { font-family:var(--font-mono); font-size:0.68rem; letter-spacing:0.05em; color:var(--text-secondary); flex-shrink:0; }
.ticker-item::before { content:'·'; margin-right:var(--space-lg); color:var(--text-dim); }
@keyframes ticker-scroll { 0%{transform:translateX(0);} 100%{transform:translateX(-50%);} }

/* ── MAIN ── */
#main-content { max-width:1280px; margin:0 auto; padding:var(--space-xl) var(--space-xl) var(--space-2xl); }

/* ── ROLE PANEL ── */
.role-panel { animation:panel-in var(--t-slow) both; }
@keyframes panel-in { from{opacity:0;transform:translateY(14px);} to{opacity:1;transform:translateY(0);} }

.panel-header { padding:var(--space-xl) 0 var(--space-lg); border-bottom:1px solid var(--bg-border); margin-bottom:var(--space-xl); display:flex; align-items:flex-start; justify-content:space-between; gap:var(--space-lg); }
.panel-header-left { display:flex; flex-direction:column; gap:var(--space-sm); }
.role-badge { display:inline-flex; align-items:center; gap:6px; font-family:var(--font-mono); font-size:0.6rem; letter-spacing:0.18em; padding:4px 10px; border-radius:99px; border:1px solid; text-transform:uppercase; width:fit-content; }
.badge-manufacturer { color:var(--teal);   background:var(--teal-glow);   border-color:var(--teal-border); }
.badge-distributor  { color:var(--amber);  background:var(--amber-glow);  border-color:var(--amber-border); }
.badge-pharmacy     { color:var(--violet); background:var(--violet-glow); border-color:var(--violet-border); }
.badge-customer     { color:var(--slate);  background:var(--slate-glow);  border-color:rgba(78,139,205,0.3); }

.panel-title { font-family:var(--font-display); font-size:2rem; font-weight:800; letter-spacing:0.05em; color:var(--text-primary); line-height:1.1; }
.panel-desc  { font-size:0.88rem; color:var(--text-secondary); font-weight:300; max-width:520px; line-height:1.65; }

/* ── 2-COL LAYOUT ── */
.panel-body { display:grid; grid-template-columns:420px 1fr; gap:var(--space-xl); align-items:start; }
.panel-body.wide { grid-template-columns:1fr; }
@media(max-width:960px){ .panel-body,.panel-body.wide{ grid-template-columns:1fr; } }

/* ── CARDS ── */
.card {
  background:var(--bg-card); border:1px solid var(--bg-border);
  border-radius:var(--radius-lg); padding:var(--space-xl);
  position:relative; overflow:hidden;
}
.card::before {
  content:''; position:absolute; left:0; top:var(--space-lg); bottom:var(--space-lg);
  width:2px; background:linear-gradient(to bottom,transparent,var(--teal-dim),transparent);
  border-radius:0 2px 2px 0;
}
.card.accent-amber::before { background:linear-gradient(to bottom,transparent,var(--amber-dim),transparent); }
.card.accent-violet::before { background:linear-gradient(to bottom,transparent,#6d4fc7,transparent); }
.card.accent-slate::before  { background:linear-gradient(to bottom,transparent,var(--slate-dim),transparent); }

.card-label { font-family:var(--font-mono); font-size:0.6rem; letter-spacing:0.2em; color:var(--text-label); text-transform:uppercase; margin-bottom:var(--space-xl); padding-bottom:var(--space-md); border-bottom:1px solid var(--bg-border); }

.result-card { animation:card-reveal var(--t-slow) both; }
@keyframes card-reveal { from{opacity:0;transform:translateX(10px);} to{opacity:1;transform:translateX(0);} }

/* ── FORMS ── */
.field-group { display:flex; flex-direction:column; gap:var(--space-sm); margin-bottom:var(--space-lg); }
.field-group:last-of-type { margin-bottom:var(--space-xl); }
.field-row { display:grid; grid-template-columns:1fr 1fr; gap:var(--space-md); }

label { font-family:var(--font-mono); font-size:0.63rem; letter-spacing:0.18em; color:var(--text-label); text-transform:uppercase; }

input[type="text"],input[type="number"],input[type="date"],select,textarea {
  background:var(--bg-input); border:1px solid var(--bg-border); border-radius:var(--radius-sm);
  color:var(--text-primary); font-family:var(--font-mono); font-size:0.85rem; letter-spacing:0.04em;
  padding:11px var(--space-md); width:100%; outline:none;
  transition:border-color var(--t-fast),box-shadow var(--t-fast),background var(--t-fast);
  appearance:none; -webkit-appearance:none;
}
input::placeholder { color:var(--text-dim); font-weight:300; }
input:focus,select:focus,textarea:focus { border-color:var(--teal-dim); background:#0c1520; box-shadow:0 0 0 3px var(--teal-glow); }

select {
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%234e6680' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:right 14px center;
  padding-right:36px; cursor:pointer;
}
select option { background:var(--bg-card); color:var(--text-primary); }
.field-hint { font-size:0.7rem; color:var(--text-dim); font-weight:300; line-height:1.4; }

/* ── BUTTONS ── */
.btn { display:inline-flex; align-items:center; justify-content:center; gap:var(--space-sm); border-radius:var(--radius-sm); font-family:var(--font-mono); font-size:0.7rem; letter-spacing:0.14em; font-weight:500; text-transform:uppercase; cursor:pointer; transition:all var(--t-fast); border:1px solid transparent; white-space:nowrap; }

.btn-primary { background:var(--teal); color:var(--bg-void); border-color:var(--teal); padding:13px var(--space-xl); width:100%; font-weight:700; position:relative; overflow:hidden; }
.btn-primary::after { content:''; position:absolute; inset:0; background:rgba(255,255,255,0); transition:background var(--t-fast); }
.btn-primary:hover::after { background:rgba(255,255,255,0.09); }
.btn-primary:active { transform:scale(0.99); }
.btn-primary:disabled { background:var(--teal-dim); border-color:var(--teal-dim); color:rgba(8,12,18,.5); cursor:not-allowed; transform:none; }

.btn-amber  { background:var(--amber);  color:var(--bg-void); border-color:var(--amber);  padding:13px var(--space-xl); width:100%; font-weight:700; }
.btn-amber:hover  { filter:brightness(1.08); }
.btn-amber:disabled  { opacity:.4; cursor:not-allowed; }

.btn-violet { background:var(--violet); color:var(--bg-void); border-color:var(--violet); padding:13px var(--space-xl); width:100%; font-weight:700; }
.btn-violet:hover { filter:brightness(1.08); }
.btn-violet:disabled { opacity:.4; cursor:not-allowed; }

.btn-slate  { background:var(--slate);  color:#fff;           border-color:var(--slate);  padding:13px var(--space-xl); width:100%; font-weight:700; }
.btn-slate:hover  { filter:brightness(1.08); }
.btn-slate:disabled  { opacity:.4; cursor:not-allowed; }

.btn-ghost  { background:transparent; color:var(--teal); border-color:var(--teal-border); padding:var(--space-sm) var(--space-lg); }
.btn-ghost:hover { background:var(--teal-glow); }

.btn-scan   { background:var(--bg-raised); color:var(--text-primary); border-color:var(--bg-border); padding:11px var(--space-xl); font-weight:600; }
.btn-scan:hover { border-color:var(--teal-border); color:var(--teal); }

.btn-loader { font-family:var(--font-mono); font-size:0.7rem; letter-spacing:0.14em; }
button:disabled .btn-loader { animation:loader-blink 1.1s step-end infinite; }
@keyframes loader-blink { 0%,100%{opacity:1;} 50%{opacity:.3;} }

/* ── RESULT ROWS ── */
.result-row { display:flex; align-items:flex-start; justify-content:space-between; gap:var(--space-md); padding:12px 0; border-bottom:1px solid var(--bg-border); }
.result-row:last-of-type { border-bottom:none; }
.result-key { font-family:var(--font-mono); font-size:0.6rem; letter-spacing:0.16em; color:var(--text-label); text-transform:uppercase; flex-shrink:0; padding-top:2px; }
.result-val { font-family:var(--font-mono); font-size:0.82rem; color:var(--text-primary); text-align:right; word-break:break-all; }

/* ── STATUS BADGES ── */
.status-badge { display:inline-block; font-family:var(--font-mono); font-size:0.63rem; font-weight:500; letter-spacing:0.12em; padding:4px 10px; border-radius:var(--radius-sm); border:1px solid; text-align:center; }
.status-manufactured { color:var(--slate);  background:var(--slate-glow);  border-color:rgba(78,139,205,.3); }
.status-transit      { color:var(--amber);  background:var(--amber-glow);  border-color:var(--amber-border); }
.status-retailer     { color:var(--violet); background:var(--violet-glow); border-color:var(--violet-border); }
.status-sold         { color:var(--text-secondary); background:rgba(125,146,170,.08); border-color:rgba(125,146,170,.2); }
.status-recalled     { color:var(--crimson); background:var(--crimson-glow); border-color:var(--crimson-border); }
.status-expired      { color:#f97316; background:rgba(249,115,22,.08); border-color:rgba(249,115,22,.25); }
.status-verified     { color:var(--teal); background:var(--teal-glow); border-color:var(--teal-border); }
.status-unknown      { color:var(--text-dim); background:transparent; border-color:var(--text-dim); }

/* ── TX LINK ── */
.tx-link { color:var(--teal); font-family:var(--font-mono); font-size:0.8rem; letter-spacing:0.03em; transition:color var(--t-fast),text-shadow var(--t-fast); }
.tx-link:hover { color:#5df0d8; text-shadow:0 0 12px var(--teal); }

/* ── QR BLOCK ── */
.qr-block { margin-top:var(--space-xl); padding-top:var(--space-xl); border-top:1px solid var(--bg-border); display:flex; flex-direction:column; align-items:center; gap:var(--space-md); }
.qr-label { font-family:var(--font-mono); font-size:0.6rem; letter-spacing:0.2em; color:var(--text-label); text-transform:uppercase; align-self:flex-start; }
.qr-img { width:180px; height:180px; border-radius:var(--radius-md); border:1px solid var(--teal-border); padding:var(--space-md); background:#fff; box-shadow:0 0 30px var(--teal-glow); transition:box-shadow var(--t-mid); }
.qr-img:hover { box-shadow:0 0 50px rgba(29,211,176,.22); }

/* ── SCAN INPUT ROW ── */
.scan-row { display:flex; gap:var(--space-sm); }
.scan-row input { flex:1; }

/* ── RISK METER ── */
.risk-meter-block { margin-bottom:var(--space-xl); padding-bottom:var(--space-xl); border-bottom:1px solid var(--bg-border); }
.risk-label-row { display:flex; justify-content:space-between; align-items:baseline; margin-bottom:var(--space-md); }
.risk-value { font-family:var(--font-mono); font-size:1.6rem; font-weight:500; color:var(--text-primary); letter-spacing:0.04em; }
.risk-bar-bg { height:6px; background:var(--bg-border); border-radius:99px; overflow:hidden; margin-bottom:var(--space-md); }
.risk-bar-fill { height:100%; width:0%; border-radius:99px; transition:width 700ms var(--ease); }
.risk-bar-fill.risk-low    { background:linear-gradient(90deg,var(--teal-dim),var(--teal)); }
.risk-bar-fill.risk-medium { background:linear-gradient(90deg,var(--amber-dim),var(--amber)); }
.risk-bar-fill.risk-high   { background:linear-gradient(90deg,var(--crimson-dim),var(--crimson)); }
.risk-verdict { font-family:var(--font-mono); font-size:0.68rem; letter-spacing:0.14em; text-transform:uppercase; display:block; }
.risk-verdict.risk-low    { color:var(--teal); }
.risk-verdict.risk-medium { color:var(--amber); }
.risk-verdict.risk-high   { color:var(--crimson); }
.risk-pill { display:inline-block; font-family:var(--font-mono); font-size:0.66rem; padding:3px 8px; border-radius:var(--radius-sm); border:1px solid; letter-spacing:0.05em; }
.risk-pill.risk-low    { color:var(--teal);   background:var(--teal-glow);   border-color:var(--teal-border); }
.risk-pill.risk-medium { color:var(--amber);  background:var(--amber-glow);  border-color:var(--amber-border); }
.risk-pill.risk-high   { color:var(--crimson);background:var(--crimson-glow);border-color:var(--crimson-border); }

/* ── AUTH BANNER ── */
.auth-verdict-banner { display:flex; align-items:center; gap:var(--space-lg); padding:var(--space-xl); border-radius:var(--radius-md); margin-bottom:var(--space-xl); border:1px solid; animation:verdict-in 400ms var(--ease) both; }
@keyframes verdict-in { from{opacity:0;transform:scale(.97);} to{opacity:1;transform:scale(1);} }
.auth-icon { font-size:2rem; font-family:var(--font-display); font-weight:800; width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0; line-height:1; }
.auth-text { font-family:var(--font-display); font-size:1.7rem; font-weight:800; letter-spacing:0.06em; }
.auth-verified { background:var(--teal-glow);   border-color:var(--teal-border); }
.auth-verified .auth-icon { background:var(--teal-glow);   color:var(--teal);   border:1px solid var(--teal-border); }
.auth-verified .auth-text { color:var(--teal); }
.auth-fake    { background:var(--crimson-glow); border-color:var(--crimson-border); }
.auth-fake .auth-icon { background:var(--crimson-glow); color:var(--crimson); border:1px solid var(--crimson-border); }
.auth-fake .auth-text { color:var(--crimson); }
.auth-error   { background:var(--amber-glow);   border-color:var(--amber-border); }
.auth-error .auth-icon { background:var(--amber-glow);   color:var(--amber);   border:1px solid var(--amber-border); }
.auth-error .auth-text { color:var(--amber); }

/* ── JOURNEY & HISTORY ── */
.journey-block,.history-block { margin-top:var(--space-xl); padding-top:var(--space-xl); border-top:1px solid var(--bg-border); }
.journey-label { font-family:var(--font-mono); font-size:0.6rem; letter-spacing:0.2em; color:var(--text-label); text-transform:uppercase; margin-bottom:var(--space-lg); }
.journey-img { width:100%; border-radius:var(--radius-md); border:1px solid var(--bg-border); background:var(--bg-input); }

/* ── HISTORY TABLE ── */
#history-table { width:100%; border-collapse:collapse; font-size:0.8rem; }
#history-table thead tr { border-bottom:1px solid var(--bg-border); }
#history-table th { font-family:var(--font-mono); font-size:0.58rem; letter-spacing:0.16em; color:var(--text-label); text-transform:uppercase; padding:var(--space-sm) var(--space-md); text-align:left; font-weight:400; }
#history-table td { padding:11px var(--space-md); color:var(--text-secondary); border-bottom:1px solid rgba(30,45,66,.6); vertical-align:middle; }
#history-table tbody tr { transition:background var(--t-fast); }
#history-table tbody tr:hover { background:rgba(29,211,176,.03); }
.row-high-risk { background:var(--crimson-glow) !important; }
.row-high-risk td { color:var(--text-primary); }
.step-pill { display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border-radius:50%; background:var(--bg-border); font-family:var(--font-mono); font-size:0.6rem; color:var(--text-secondary); font-weight:500; }

/* ── TIMELINE (Customer view) ── */
.timeline { padding-left:var(--space-md); }
.timeline-item { position:relative; padding-left:var(--space-xl); padding-bottom:var(--space-lg); border-left:1px solid var(--bg-border); }
.timeline-item:last-child { border-left:1px solid transparent; padding-bottom:0; }
.timeline-dot { position:absolute; left:-7px; top:4px; width:13px; height:13px; border-radius:50%; background:var(--teal); border:2px solid var(--bg-void); }
.timeline-dot.amber  { background:var(--amber); }
.timeline-dot.violet { background:var(--violet); }
.timeline-dot.slate  { background:var(--slate); }
.timeline-role   { font-family:var(--font-mono); font-size:0.6rem; letter-spacing:0.14em; color:var(--teal); text-transform:uppercase; margin-bottom:3px; }
.timeline-action { font-family:var(--font-body); font-weight:600; font-size:0.9rem; color:var(--text-primary); margin-bottom:2px; }
.timeline-detail { font-size:0.8rem; color:var(--text-secondary); font-weight:300; margin-bottom:4px; }
.timeline-date   { font-family:var(--font-mono); font-size:0.65rem; color:var(--text-dim); }

/* ── LEDGER TABLE ── */
.ledger-wrap { margin-top:var(--space-2xl); }
.ledger-header { display:flex; align-items:center; justify-content:space-between; padding:var(--space-md) var(--space-lg); background:var(--bg-raised); border:1px solid var(--bg-border); border-bottom:none; border-radius:var(--radius-lg) var(--radius-lg) 0 0; }
.ledger-title { font-family:var(--font-mono); font-size:0.62rem; letter-spacing:0.18em; color:var(--teal); text-transform:uppercase; }
.ledger-reset { font-family:var(--font-mono); font-size:0.62rem; letter-spacing:0.1em; color:var(--crimson); cursor:pointer; background:none; border:none; transition:color var(--t-fast); padding:4px 8px; border-radius:var(--radius-sm); }
.ledger-reset:hover { color:#ff7a94; background:var(--crimson-glow); }
.ledger-table-wrap { overflow-x:auto; background:var(--bg-card); border:1px solid var(--bg-border); border-radius:0 0 var(--radius-lg) var(--radius-lg); }
#ledger-table { width:100%; border-collapse:collapse; font-size:0.8rem; }
#ledger-table th { font-family:var(--font-mono); font-size:0.58rem; letter-spacing:0.16em; color:var(--text-label); text-transform:uppercase; padding:var(--space-sm) var(--space-lg); text-align:left; font-weight:400; border-bottom:1px solid var(--bg-border); background:var(--bg-raised); }
#ledger-table td { padding:12px var(--space-lg); color:var(--text-secondary); border-bottom:1px solid rgba(30,45,66,.5); vertical-align:middle; }
#ledger-table tbody tr { transition:background var(--t-fast); }
#ledger-table tbody tr:hover { background:rgba(29,211,176,.025); }
#ledger-empty { padding:var(--space-2xl); text-align:center; font-family:var(--font-mono); font-size:0.75rem; color:var(--text-dim); letter-spacing:0.1em; }

/* ── TOAST ── */
.toast { position:fixed; bottom:var(--space-xl); right:var(--space-xl); z-index:9999; min-width:280px; max-width:400px; padding:14px var(--space-lg); border-radius:var(--radius-md); font-family:var(--font-mono); font-size:0.73rem; letter-spacing:0.06em; line-height:1.5; border:1px solid; backdrop-filter:blur(12px); animation:toast-in var(--t-mid) var(--ease) both; }
@keyframes toast-in { from{opacity:0;transform:translateY(12px) scale(.97);} to{opacity:1;transform:translateY(0) scale(1);} }
.toast.hidden { opacity:0; pointer-events:none; display:flex !important; animation:toast-out var(--t-fast) var(--ease) forwards; }
@keyframes toast-out { to{opacity:0;transform:translateY(8px);} }
.toast-success { background:rgba(13,20,32,.96); border-color:var(--teal-border);   color:var(--teal);  }
.toast-error   { background:rgba(13,20,32,.96); border-color:var(--crimson-border); color:var(--crimson); }
.toast-warning { background:rgba(13,20,32,.96); border-color:var(--amber-border);   color:var(--amber); }
.toast-info    { background:rgba(13,20,32,.96); border-color:var(--bg-border);       color:var(--text-secondary); }

/* ── FOOTER ── */
#site-footer { max-width:1280px; margin:0 auto; padding:var(--space-lg) var(--space-xl); border-top:1px solid var(--bg-border); display:flex; justify-content:space-between; align-items:center; gap:var(--space-md); flex-wrap:wrap; }
#site-footer span { font-family:var(--font-mono); font-size:0.6rem; letter-spacing:0.1em; color:var(--text-dim); }

/* ── SCROLLBAR ── */
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:var(--bg-void); }
::-webkit-scrollbar-thumb { background:var(--bg-border); border-radius:99px; }
::-webkit-scrollbar-thumb:hover { background:var(--text-dim); }
::selection { background:var(--teal-glow); color:var(--teal); }

/* ── RESPONSIVE ── */
@media(max-width:768px){
  .header-inner { padding:0 var(--space-lg); gap:var(--space-md); }
  .logo-sub,.chain-status { display:none; }
  #role-nav { gap:1px; }
  .role-btn { padding:7px 10px; font-size:0.6rem; }
  .role-icon { display:none; }
  #main-content { padding:var(--space-lg); }
  .panel-title { font-size:1.5rem; }
  .card { padding:var(--space-lg); }
  .field-row { grid-template-columns:1fr; }
  .auth-text { font-size:1.2rem; }
  .toast { left:var(--space-lg); right:var(--space-lg); min-width:unset; }
  #ledger-table th:nth-child(5),#ledger-table td:nth-child(5) { display:none; }
}
</style>
</head>
<body>

<!-- ═══════════════════════════════════════════
     HEADER
═══════════════════════════════════════════ -->
<header id="site-header">
  <div class="header-inner">
    <div class="logo-block">
      <div class="logo-icon">&#11042;</div>
      <div class="logo-text">
        <span class="logo-main">PHARMACHAIN</span>
        <span class="logo-sub">ANTI-COUNTERFEIT SUPPLY TRACKER</span>
      </div>
    </div>

    <nav id="role-nav">
      <button class="role-btn active" data-role="manufacturer"><span class="role-icon">&#9874;</span>MANUFACTURER</button>
      <button class="role-btn" data-role="distributor"><span class="role-icon">&#10148;</span>DISTRIBUTOR</button>
      <button class="role-btn" data-role="pharmacy"><span class="role-icon">&#43;</span>PHARMACY</button>
      <button class="role-btn" data-role="customer"><span class="role-icon">&#9632;</span>CUSTOMER</button>
    </nav>

    <div class="chain-status">
      <span class="status-dot" id="chain-dot"></span>
      <span id="chain-label">CONNECTING...</span>
    </div>
  </div>
</header>

<!-- ═══════════════════════════════════════════
     TICKER
═══════════════════════════════════════════ -->
<div id="ticker-bar">
  <span class="ticker-label">CHAIN FEED</span>
  <div class="ticker-track">
    <span class="ticker-item">Block #21,834,001 Confirmed</span>
    <span class="ticker-item">M-001 Verified — Batch B-101</span>
    <span class="ticker-item">Expiry Check Triggered — M-003</span>
    <span class="ticker-item">New Manufacture — M-004 Registered</span>
    <span class="ticker-item">Handover Risk: 0.12 — SAFE</span>
    <span class="ticker-item">Batch B-207 Dispatched to Pharmacy</span>
  </div>
</div>

<!-- ═══════════════════════════════════════════
     MAIN
═══════════════════════════════════════════ -->
<main id="main-content">
  <div id="role-view"><!-- injected by JS --></div>

  <!-- LEDGER -->
  <div class="ledger-wrap">
    <div class="ledger-header">
      <span class="ledger-title">&#9632; Live Blockchain Ledger</span>
      <button class="ledger-reset" onclick="PC.clearLedger()">RESET CHAIN</button>
    </div>
    <div class="ledger-table-wrap">
      <table id="ledger-table">
        <thead>
          <tr>
            <th>Medicine ID</th>
            <th>Batch ID</th>
            <th>Drug Name</th>
            <th>Owner</th>
            <th>Status</th>
            <th>Weight (g)</th>
            <th>Last Updated</th>
          </tr>
        </thead>
        <tbody id="ledger-body"></tbody>
      </table>
      <div id="ledger-empty">No transactions recorded yet.</div>
    </div>
  </div>
</main>

<!-- FOOTER -->
<footer id="site-footer">
  <span>PHARMACHAIN v2.0 — SEPOLIA TESTNET</span>
  <span>FastAPI &nbsp;·&nbsp; MongoDB &nbsp;·&nbsp; Solidity &nbsp;·&nbsp; AI Risk Engine</span>
</footer>

<!-- TOAST -->
<div id="toast" class="toast hidden"><span id="toast-msg"></span></div>


<!-- ═══════════════════════════════════════════
     JAVASCRIPT
═══════════════════════════════════════════ -->
<script>
'use strict';

/* ─────────────────────────────────────────
   CONFIG
───────────────────────────────────────── */
const API_BASE = 'https://nirmalll17-centralhack.hf.space';

const STATUS_MAP = {
  0:{ label:'MANUFACTURED', cls:'status-manufactured' },
  1:{ label:'IN TRANSIT',   cls:'status-transit'       },
  2:{ label:'AT RETAILER',  cls:'status-retailer'      },
  3:{ label:'SOLD',         cls:'status-sold'           },
  4:{ label:'RECALLED',     cls:'status-recalled'       },
  5:{ label:'EXPIRED',      cls:'status-expired'        },
  6:{ label:'VERIFIED',     cls:'status-verified'       },
};

const RISK_LEVELS = {
  LOW:    { max:0.35, label:'LOW RISK — SAFE TO PROCEED',   cls:'risk-low'    },
  MEDIUM: { max:0.65, label:'MEDIUM RISK — INSPECT BATCH',  cls:'risk-medium' },
  HIGH:   { max:1.00, label:'HIGH RISK — FLAG FOR REVIEW',  cls:'risk-high'   },
};

const ROLE_DOT_COLORS = {
  manufacturer:{ color:'var(--teal)',   cls:'badge-manufacturer' },
  distributor: { color:'var(--amber)',  cls:'badge-distributor'  },
  pharmacy:    { color:'var(--violet)', cls:'badge-pharmacy'     },
  customer:    { color:'var(--slate)',  cls:'badge-customer'     },
};

/* ─────────────────────────────────────────
   UTILITIES
───────────────────────────────────────── */
function $(id){ return document.getElementById(id); }
function showToast(msg, type='info'){
  const t=$('toast'); const m=$('toast-msg');
  t.className=`toast toast-${type}`;
  m.textContent=msg;
  t.classList.remove('hidden');
  clearTimeout(t._timer);
  t._timer=setTimeout(()=>t.classList.add('hidden'),4000);
}
function setLoading(btnId,on){
  const btn=$(btnId);
  if(!btn)return;
  const txt=btn.querySelector('.btn-text');
  const ldr=btn.querySelector('.btn-loader');
  btn.disabled=on;
  if(txt)txt.classList.toggle('hidden',on);
  if(ldr)ldr.classList.toggle('hidden',!on);
}
function truncateHash(h){ if(!h||h.length<20)return h||'—'; return `${h.slice(0,10)}...${h.slice(-8)}`; }
function fmtTimestamp(iso){ try{ return new Date(iso).toLocaleString(); }catch{ return iso||'—'; } }
function getRisk(score){
  if(score<=RISK_LEVELS.LOW.max)    return RISK_LEVELS.LOW;
  if(score<=RISK_LEVELS.MEDIUM.max) return RISK_LEVELS.MEDIUM;
  return RISK_LEVELS.HIGH;
}
function animateCounter(el,target,dec=4,dur=900){
  const start=performance.now();
  function step(now){
    const p=Math.min((now-start)/dur,1);
    el.textContent=(target*p).toFixed(dec);
    if(p<1)requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
function animateBar(barEl,score){
  barEl.style.width='0%';
  setTimeout(()=>{ barEl.style.width=`${(score*100).toFixed(1)}%`; },80);
}
function renderStatusBadge(el,code){
  const s=STATUS_MAP[code]??{label:`CODE ${code}`,cls:'status-unknown'};
  el.textContent=s.label;
  el.className=`result-val status-badge ${s.cls}`;
}
function txLink(hash){
  if(!hash)return '—';
  return `<a href="https://sepolia.etherscan.io/tx/${hash}" target="_blank" rel="noopener" class="tx-link">${truncateHash(hash)} &nearr;</a>`;
}

async function apiPost(endpoint,body){
  const r=await fetch(`${API_BASE}${endpoint}`,{
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
  });
  const d=await r.json();
  if(!r.ok) throw new Error(d.detail||`Error ${r.status}`);
  return d;
}

/* ─────────────────────────────────────────
   LOCAL LEDGER (mirror of blockchain state)
───────────────────────────────────────── */
const PC = {
  ledger: JSON.parse(localStorage.getItem('pc_ledger')||'[]'),
  role: 'manufacturer',

  saveLedger(){
    localStorage.setItem('pc_ledger', JSON.stringify(this.ledger));
    this.renderLedger();
  },
  upsertLedger(entry){
    const idx=this.ledger.findIndex(r=>r.medicineId===entry.medicineId);
    if(idx>-1) Object.assign(this.ledger[idx],entry);
    else this.ledger.unshift(entry);
    this.saveLedger();
  },
  findBatch(id){
    return this.ledger.find(r=>r.medicineId===id||r.batchId===id);
  },
  clearLedger(){
    if(!confirm('Reset the local ledger? On-chain data is unaffected.'))return;
    this.ledger=[];
    this.saveLedger();
    showToast('Local ledger cleared.','warning');
  },

  renderLedger(){
    const tbody=$('ledger-body'), empty=$('ledger-empty');
    if(!this.ledger.length){ tbody.innerHTML=''; empty.classList.remove('hidden'); return; }
    empty.classList.add('hidden');
    tbody.innerHTML=this.ledger.map(r=>{
      const s=STATUS_MAP[r.statusCode]??{label:'UNKNOWN',cls:'status-unknown'};
      return `<tr>
        <td class="mono" style="color:var(--teal)">${r.medicineId||'—'}</td>
        <td class="mono">${r.batchId||'—'}</td>
        <td style="color:var(--text-primary);font-weight:600">${r.name||'—'}</td>
        <td><span style="font-family:var(--font-mono);font-size:.65rem;letter-spacing:.1em;color:var(--text-secondary);text-transform:uppercase">${r.owner||'—'}</span></td>
        <td><span class="status-badge ${s.cls}">${s.label}</span></td>
        <td class="mono">${r.weight||'—'}</td>
        <td class="small">${fmtTimestamp(r.updatedAt)}</td>
      </tr>`;
    }).join('');
  },

  /* ── NAVIGATION ── */
  setRole(role){
    this.role=role;
    document.querySelectorAll('.role-btn').forEach(b=>b.classList.toggle('active',b.dataset.role===role));
    this.renderView();
  },

  renderView(){
    const v=$('role-view');
    v.innerHTML='';
    const panel=document.createElement('div');
    panel.className='role-panel';
    panel.innerHTML=this[`view_${this.role}`]();
    v.appendChild(panel);
    this[`init_${this.role}`]?.();
  },

  /* ═══════════════════════════════════════
     MANUFACTURER VIEW
  ═══════════════════════════════════════ */
  view_manufacturer(){
    return `
    <div class="panel-header">
      <div class="panel-header-left">
        <span class="role-badge badge-manufacturer">&#9874; Manufacturer</span>
        <h1 class="panel-title">REGISTER MEDICINE</h1>
        <p class="panel-desc">Create a new medicine unit on-chain. All fields map directly to the Medicine struct. A QR code linked to this Batch ID will be generated on Sepolia.</p>
      </div>
    </div>
    <div class="panel-body">

      <div class="card">
        <div class="card-label">01 — Medicine Struct Parameters</div>
        <form id="mfr-form">

          <div class="field-row">
            <div class="field-group">
              <label for="mfr-medicine-id">Medicine ID</label>
              <input type="text" id="mfr-medicine-id" name="medicine_id" placeholder="e.g. M-555" required>
              <span class="field-hint">QR on the individual packet.</span>
            </div>
            <div class="field-group">
              <label for="mfr-batch-id">Batch ID (Parent)</label>
              <input type="text" id="mfr-batch-id" name="batch_id" placeholder="e.g. B-101" required>
              <span class="field-hint">QR on the bulk box.</span>
            </div>
          </div>

          <div class="field-group">
            <label for="mfr-name">Medicine Name</label>
            <input type="text" id="mfr-name" name="medicine_name" placeholder="e.g. Paracetamol 500mg" required>
          </div>

          <div class="field-row">
            <div class="field-group">
              <label for="mfr-weight">Expected Weight (grams)</label>
              <input type="number" id="mfr-weight" name="weight" placeholder="e.g. 100" min="1" required>
              <span class="field-hint">expectedWeight in struct.</span>
            </div>
            <div class="field-group">
              <label for="mfr-expiry">Expiry Date</label>
              <input type="date" id="mfr-expiry" name="expiry_date" required>
              <span class="field-hint">Converted to UNIX timestamp.</span>
            </div>
          </div>

          <div class="field-group">
            <label for="mfr-location">Manufacturer Location (GPS)</label>
            <input type="text" id="mfr-location" name="location" placeholder="e.g. 13.0827,80.2707" required>
            <span class="field-hint">manufacturerLoc — lat,lng format.</span>
          </div>

          <button type="submit" class="btn btn-primary" id="mfr-btn">
            <span class="btn-text">REGISTER ON-CHAIN</span>
            <span class="btn-loader hidden">BROADCASTING...</span>
          </button>
        </form>
      </div>

      <div class="card result-card hidden" id="mfr-result">
        <div class="card-label">02 — Blockchain Receipt</div>
        <div class="result-row"><span class="result-key">TX Hash</span><span class="result-val mono" id="res-mfr-tx">—</span></div>
        <div class="result-row"><span class="result-key">Medicine ID</span><span class="result-val mono" id="res-mfr-mid">—</span></div>
        <div class="result-row"><span class="result-key">Batch ID</span><span class="result-val mono" id="res-mfr-bid">—</span></div>
        <div class="result-row"><span class="result-key">Weight</span><span class="result-val mono" id="res-mfr-wt">—</span></div>
        <div class="result-row"><span class="result-key">Expiry</span><span class="result-val" id="res-mfr-exp">—</span></div>
        <div class="result-row"><span class="result-key">Status</span><span class="result-val status-badge" id="res-mfr-status">—</span></div>
        <div class="qr-block">
          <span class="qr-label">Batch QR Code</span>
          <img id="res-mfr-qr" src="" alt="QR" class="qr-img">
          <a id="res-mfr-dl" href="#" download class="btn btn-ghost">DOWNLOAD QR</a>
        </div>
      </div>

    </div>`;
  },

  init_manufacturer(){
    // Set min date to tomorrow
    const d=new Date(); d.setDate(d.getDate()+1);
    $('mfr-expiry').min=d.toISOString().split('T')[0];

    $('mfr-form').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const f=e.target;

      // GPS validation
      if(!/^-?\d+(\.\d+)?,-?\d+(\.\d+)?$/.test(f.location.value.trim())){
        showToast('GPS format: lat,lng — e.g. 13.0827,80.2707','error'); return;
      }

      setLoading('mfr-btn',true);
      try{
        const expiryTs=Math.floor(new Date(f.expiry_date.value).getTime()/1000);

        const data=await apiPost('/api/manufacture',{
          batch_id:      f.batch_id.value.trim(),
          medicine_name: f.medicine_name.value.trim(),
          location:      f.location.value.trim(),
          // Extra fields passed through for full struct compliance
          medicine_id:   f.medicine_id.value.trim(),
          weight:        parseInt(f.weight.value),
          expiry_date:   expiryTs,
        });

        $('res-mfr-tx').innerHTML   = txLink(data.tx_hash);
        $('res-mfr-mid').textContent= f.medicine_id.value.trim();
        $('res-mfr-bid').textContent= f.batch_id.value.trim();
        $('res-mfr-wt').textContent = f.weight.value+' g';
        $('res-mfr-exp').textContent= new Date(f.expiry_date.value).toLocaleDateString('en-IN',{year:'numeric',month:'long',day:'numeric'});

        const sEl=$('res-mfr-status');
        sEl.textContent='MANUFACTURED'; sEl.className='result-val status-badge status-manufactured';

        const qr=$('res-mfr-qr');
        qr.src=`${API_BASE}${data.qr_url}`;
        qr.onerror=()=>qr.src=`https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${f.batch_id.value.trim()}`;
        $('res-mfr-dl').href=qr.src;
        $('res-mfr-dl').download=`${f.batch_id.value.trim()}_QR.png`;

        $('mfr-result').classList.remove('hidden');

        // Mirror to ledger
        this.upsertLedger({
          medicineId: f.medicine_id.value.trim(),
          batchId:    f.batch_id.value.trim(),
          name:       f.medicine_name.value.trim(),
          weight:     f.weight.value,
          owner:      'manufacturer',
          statusCode: 0,
          txHash:     data.tx_hash,
          updatedAt:  new Date().toISOString(),
        });

        showToast(`${f.batch_id.value.trim()} registered on Sepolia!`,'success');

      }catch(err){
        showToast(`Error: ${err.message}`,'error');
        console.error('[Manufacture]',err);
      }finally{
        setLoading('mfr-btn',false);
      }
    });
  },

  /* ═══════════════════════════════════════
     DISTRIBUTOR VIEW
  ═══════════════════════════════════════ */
  view_distributor(){
    return `
    <div class="panel-header">
      <div class="panel-header-left">
        <span class="role-badge badge-distributor">&#10148; Distributor</span>
        <h1 class="panel-title">LOGISTICS HANDOVER</h1>
        <p class="panel-desc">Scan a Batch ID to update location and transfer status. The AI risk engine scores each transfer for anomalies before writing to the blockchain.</p>
      </div>
    </div>
    <div class="panel-body">

      <div class="card accent-amber">
        <div class="card-label">01 — Transfer Details</div>
        <form id="dist-form">
          <div class="field-group">
            <label for="dist-batch">Batch ID</label>
            <div class="scan-row">
              <input type="text" id="dist-batch" name="batch_id" placeholder="e.g. B-101" required>
              <button type="button" class="btn btn-scan" onclick="PC.lookupBatch('dist-batch','dist-info')">LOOKUP</button>
            </div>
          </div>

          <div id="dist-info" class="hidden" style="margin-bottom:var(--space-lg);padding:var(--space-md);background:var(--bg-input);border-radius:var(--radius-md);border:1px solid var(--bg-border)">
            <div style="font-family:var(--font-mono);font-size:.65rem;color:var(--text-label);letter-spacing:.12em;margin-bottom:8px">FOUND ON LEDGER</div>
            <div id="dist-info-content"></div>
          </div>

          <div class="field-group">
            <label for="dist-location">New Location (GPS)</label>
            <input type="text" id="dist-location" name="new_location" placeholder="e.g. 28.6139,77.2090" required>
            <span class="field-hint">Used for teleportation-check distance calc.</span>
          </div>

          <div class="field-group">
            <label for="dist-role">Transfer To</label>
            <select id="dist-role" name="role_index" required>
              <option value="" disabled selected>— SELECT RECIPIENT —</option>
              <option value="1">Distributor Hub (In Transit)</option>
              <option value="2">Pharmacy / Hospital (At Retailer)</option>
            </select>
          </div>

          <button type="submit" class="btn btn-amber" id="dist-btn">
            <span class="btn-text">EXECUTE HANDOVER</span>
            <span class="btn-loader hidden">ANALYZING RISK...</span>
          </button>
        </form>
      </div>

      <div class="card accent-amber result-card hidden" id="dist-result">
        <div class="card-label">02 — AI Risk Analysis + Chain Receipt</div>

        <div class="risk-meter-block">
          <div class="risk-label-row">
            <span class="result-key">AI RISK SCORE</span>
            <span class="risk-value" id="res-dist-risk">0.0000</span>
          </div>
          <div class="risk-bar-bg"><div class="risk-bar-fill" id="res-dist-bar"></div></div>
          <span class="risk-verdict" id="res-dist-verdict">—</span>
        </div>

        <div class="result-row"><span class="result-key">TX Hash</span><span class="result-val mono" id="res-dist-tx">—</span></div>
        <div class="result-row"><span class="result-key">New Status</span><span class="result-val status-badge" id="res-dist-status">—</span></div>
        <div class="result-row"><span class="result-key">Location Logged</span><span class="result-val mono" id="res-dist-loc">—</span></div>
      </div>

    </div>`;
  },

  init_distributor(){
    $('dist-form').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const f=e.target;
      if(!/^-?\d+(\.\d+)?,-?\d+(\.\d+)?$/.test(f.new_location.value.trim())){
        showToast('GPS format: lat,lng','error'); return;
      }
      if(!f.role_index.value){ showToast('Select recipient role.','error'); return; }

      setLoading('dist-btn',true);
      try{
        const body={
          batch_id:     f.batch_id.value.trim(),
          new_location: f.new_location.value.trim(),
          role_index:   parseInt(f.role_index.value),
        };
        const data=await apiPost('/api/handover',body);

        const riskScore=parseFloat(data.risk_score)||0;
        const rl=getRisk(riskScore);

        animateCounter($('res-dist-risk'),riskScore,4,900);
        const bar=$('res-dist-bar');
        bar.className=`risk-bar-fill ${rl.cls}`;
        animateBar(bar,riskScore);
        $('res-dist-verdict').textContent=rl.label;
        $('res-dist-verdict').className=`risk-verdict ${rl.cls}`;

        $('res-dist-tx').innerHTML=txLink(data.tx_hash);
        $('res-dist-loc').textContent=f.new_location.value.trim();
        renderStatusBadge($('res-dist-status'),body.role_index);

        $('dist-result').classList.remove('hidden');

        // Update ledger
        const existing=this.findBatch(f.batch_id.value.trim());
        if(existing){
          existing.statusCode=body.role_index;
          existing.owner='distributor';
          existing.txHash=data.tx_hash;
          existing.updatedAt=new Date().toISOString();
          this.saveLedger();
        }

        showToast(riskScore>0.65?`High risk (${riskScore.toFixed(4)}) — inspect batch`:`Handover recorded. Risk: ${riskScore.toFixed(4)}`, riskScore>0.65?'warning':'success');

      }catch(err){
        showToast(`Error: ${err.message}`,'error');
        console.error('[Distributor]',err);
      }finally{
        setLoading('dist-btn',false);
      }
    });
  },

  /* ═══════════════════════════════════════
     PHARMACY VIEW
  ═══════════════════════════════════════ */
  view_pharmacy(){
    return `
    <div class="panel-header">
      <div class="panel-header-left">
        <span class="role-badge badge-pharmacy">&#43; Pharmacy</span>
        <h1 class="panel-title">VERIFY & DISPENSE</h1>
        <p class="panel-desc">Authenticate received stock against the blockchain. Ghost, Zombie, and Teleportation checks run automatically. Mark verified items as sold to consumers.</p>
      </div>
    </div>
    <div class="panel-body">

      <div class="card accent-violet">
        <div class="card-label">01 — Scan / Enter ID</div>
        <form id="pharm-form">
          <div class="field-group">
            <label for="pharm-mid">Medicine ID</label>
            <div class="scan-row">
              <input type="text" id="pharm-mid" name="medicine_id" placeholder="e.g. M-555" required>
              <button type="button" class="btn btn-scan" onclick="PC.lookupBatch('pharm-mid','pharm-info')">LOOKUP</button>
            </div>
          </div>

          <div id="pharm-info" class="hidden" style="margin-bottom:var(--space-lg);padding:var(--space-md);background:var(--bg-input);border-radius:var(--radius-md);border:1px solid var(--bg-border)">
            <div style="font-family:var(--font-mono);font-size:.65rem;color:var(--text-label);letter-spacing:.12em;margin-bottom:8px">FOUND ON LEDGER</div>
            <div id="pharm-info-content"></div>
          </div>

          <div class="field-group">
            <label for="pharm-loc">Scan Location (GPS)</label>
            <input type="text" id="pharm-loc" name="location" placeholder="e.g. 19.0760,72.8777" required>
          </div>

          <button type="submit" class="btn btn-violet" id="pharm-btn">
            <span class="btn-text">AUTHENTICATE</span>
            <span class="btn-loader hidden">QUERYING CHAIN...</span>
          </button>
        </form>
      </div>

      <div class="card accent-violet result-card hidden" id="pharm-result">
        <div class="card-label">02 — Authentication Result</div>

        <div class="auth-verdict-banner" id="pharm-banner">
          <div class="auth-icon" id="pharm-icon">?</div>
          <div class="auth-text" id="pharm-text">PENDING</div>
        </div>

        <div class="result-row"><span class="result-key">Medicine Name</span><span class="result-val" id="res-pharm-name">—</span></div>
        <div class="result-row"><span class="result-key">Last Location</span><span class="result-val mono" id="res-pharm-loc">—</span></div>
        <div class="result-row"><span class="result-key">Status</span><span class="result-val status-badge" id="res-pharm-status">—</span></div>

        <div class="journey-block hidden" id="pharm-journey">
          <div class="journey-label">AI Supply Chain Journey</div>
          <img id="pharm-graph" src="" alt="Journey graph" class="journey-img">
        </div>

        <div class="history-block hidden" id="pharm-history">
          <div class="journey-label">Movement History</div>
          <table id="history-table">
            <thead><tr><th>#</th><th>Role</th><th>Location</th><th>AI Risk</th><th>Timestamp</th><th>TX</th></tr></thead>
            <tbody id="history-tbody"></tbody>
          </table>
        </div>

        <!-- Mark as sold (only shown when verified) -->
        <div id="pharm-sell-wrap" class="hidden" style="margin-top:var(--space-xl);padding-top:var(--space-xl);border-top:1px solid var(--bg-border)">
          <button class="btn btn-violet" id="pharm-sell-btn" onclick="PC.markSold()">
            <span class="btn-text">MARK AS SOLD</span>
            <span class="btn-loader hidden">UPDATING...</span>
          </button>
        </div>
      </div>

    </div>`;
  },

  init_pharmacy(){
    this._lastVerifiedId=null;
    $('pharm-form').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const f=e.target;
      setLoading('pharm-btn',true);
      $('pharm-result').classList.add('hidden');
      $('pharm-journey').classList.add('hidden');
      $('pharm-history').classList.add('hidden');
      $('pharm-sell-wrap').classList.add('hidden');
      try{
        const body={medicine_id:f.medicine_id.value.trim(), location:f.location.value.trim()};
        const data=await apiPost('/api/verify',body);
        this._lastVerifiedId=body.medicine_id;

        // Auth banner
        const banner=$('pharm-banner'), icon=$('pharm-icon'), txt=$('pharm-text');
        if(data.status==='verified'){
          banner.className='auth-verdict-banner auth-verified'; icon.textContent='&#10003;'; txt.textContent='AUTHENTIC';
          $('pharm-sell-wrap').classList.remove('hidden');
        } else if(data.status==='fake'){
          banner.className='auth-verdict-banner auth-fake'; icon.textContent='&#10007;'; txt.textContent='COUNTERFEIT DETECTED';
        } else {
          banner.className='auth-verdict-banner auth-error'; icon.textContent='!'; txt.textContent='VERIFY ERROR';
        }

        const bc=data.blockchain_data||{};
        $('res-pharm-name').textContent=bc.name||'—';
        $('res-pharm-loc').textContent=bc.current_location||'—';
        renderStatusBadge($('res-pharm-status'),bc.status_code);

        if(data.graph_url){
          const g=$('pharm-graph');
          g.src=`${API_BASE}${data.graph_url}`;
          g.onerror=()=>$('pharm-journey').classList.add('hidden');
          $('pharm-journey').classList.remove('hidden');
        }

        if(data.history?.length){ this.buildHistory(data.history); $('pharm-history').classList.remove('hidden'); }

        $('pharm-result').classList.remove('hidden');

        // Update ledger
        if(bc.status_code!==undefined){
          const rec=this.findBatch(body.medicine_id);
          if(rec){ rec.statusCode=bc.status_code; rec.updatedAt=new Date().toISOString(); this.saveLedger(); }
        }

        showToast(`Verification: ${data.status.toUpperCase()}`, data.status==='verified'?'success':data.status==='fake'?'error':'warning');
      }catch(err){
        showToast(`Error: ${err.message}`,'error'); console.error('[Pharmacy]',err);
      }finally{ setLoading('pharm-btn',false); }
    });
  },

  markSold(){
    const id=this._lastVerifiedId; if(!id)return;
    const rec=this.findBatch(id);
    if(rec){ rec.statusCode=3; rec.owner='customer'; rec.updatedAt=new Date().toISOString(); this.saveLedger(); }
    $('pharm-sell-wrap').classList.add('hidden');
    renderStatusBadge($('res-pharm-status'),3);
    showToast(`${id} marked as SOLD on local ledger.`,'success');
  },

  buildHistory(history){
    const tbody=$('history-tbody'); tbody.innerHTML='';
    history.forEach((r,i)=>{
      const risk=parseFloat(r.risk_score)||0;
      const rl=getRisk(risk);
      const roles={Factory:'&#9874;',Distributor:'&#10148;',Pharmacy:'&#43;'};
      const icon=roles[r.role]||'&#9632;';
      const tr=document.createElement('tr');
      if(risk>0.65) tr.classList.add('row-high-risk');
      tr.innerHTML=`
        <td><span class="step-pill">${i+1}</span></td>
        <td style="color:var(--text-primary)">${icon} ${r.role||'—'}</td>
        <td class="mono small">${r.location||'—'}</td>
        <td><span class="risk-pill ${rl.cls}">${risk.toFixed(4)}</span></td>
        <td class="small">${fmtTimestamp(r.timestamp)}</td>
        <td class="mono small">${r.tx_hash?`<a href="https://sepolia.etherscan.io/tx/${r.tx_hash}" target="_blank" rel="noopener" class="tx-link">${truncateHash(r.tx_hash)} &nearr;</a>`:'—'}</td>
      `;
      tbody.appendChild(tr);
    });
  },

  /* ═══════════════════════════════════════
     CUSTOMER VIEW
  ═══════════════════════════════════════ */
  view_customer(){
    return `
    <div class="panel-header">
      <div class="panel-header-left">
        <span class="role-badge badge-customer">&#9632; Customer</span>
        <h1 class="panel-title">VERIFY YOUR MEDICINE</h1>
        <p class="panel-desc">Check if your medicine is authentic. Enter the Medicine ID or Batch ID printed on the package to trace its full blockchain journey.</p>
      </div>
    </div>
    <div class="panel-body" style="grid-template-columns:400px 1fr">

      <div class="card accent-slate">
        <div class="card-label">01 — Enter Medicine ID</div>

        <!-- Scan frame (visual) -->
        <div style="position:relative;width:100%;height:160px;background:var(--bg-void);border-radius:var(--radius-md);overflow:hidden;margin-bottom:var(--space-xl);border:1px solid var(--bg-border)">
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:1">
            <div style="font-size:2.5rem;color:var(--text-dim)">&#9647;</div>
          </div>
          <!-- Scan line animation -->
          <div style="position:absolute;left:0;right:0;height:1px;background:var(--slate);z-index:2;animation:scan-line 2.5s linear infinite;box-shadow:0 0 8px var(--slate)"></div>
          <!-- Corner markers -->
          <div style="position:absolute;top:12px;left:12px;width:18px;height:18px;border-top:2px solid rgba(255,255,255,.3);border-left:2px solid rgba(255,255,255,.3)"></div>
          <div style="position:absolute;top:12px;right:12px;width:18px;height:18px;border-top:2px solid rgba(255,255,255,.3);border-right:2px solid rgba(255,255,255,.3)"></div>
          <div style="position:absolute;bottom:12px;left:12px;width:18px;height:18px;border-bottom:2px solid rgba(255,255,255,.3);border-left:2px solid rgba(255,255,255,.3)"></div>
          <div style="position:absolute;bottom:12px;right:12px;width:18px;height:18px;border-bottom:2px solid rgba(255,255,255,.3);border-right:2px solid rgba(255,255,255,.3)"></div>
          <div style="position:absolute;bottom:6px;width:100%;text-align:center;font-family:var(--font-mono);font-size:.55rem;color:rgba(255,255,255,.2);letter-spacing:.15em;z-index:2">SIMULATED CAMERA FEED</div>
        </div>

        <form id="cust-form">
          <div class="field-group">
            <label for="cust-id">Medicine ID / Batch ID</label>
            <input type="text" id="cust-id" name="medicine_id" placeholder="e.g. M-555 or B-101" required>
          </div>
          <div class="field-group">
            <label for="cust-loc">Your Location (GPS)</label>
            <input type="text" id="cust-loc" name="location" placeholder="e.g. 12.9716,77.5946">
            <span class="field-hint">Optional — used for location-based checks.</span>
          </div>
          <button type="submit" class="btn btn-slate" id="cust-btn">
            <span class="btn-text">CHECK AUTHENTICITY</span>
            <span class="btn-loader hidden">VERIFYING...</span>
          </button>
        </form>
      </div>

      <div class="card accent-slate result-card hidden" id="cust-result">
        <div class="card-label">02 — Product Verification</div>

        <div class="auth-verdict-banner" id="cust-banner">
          <div class="auth-icon" id="cust-icon">?</div>
          <div class="auth-text" id="cust-text">PENDING</div>
        </div>

        <div class="result-row"><span class="result-key">Medicine Name</span><span class="result-val" id="res-cust-name">—</span></div>
        <div class="result-row"><span class="result-key">Last Known Location</span><span class="result-val mono" id="res-cust-loc">—</span></div>
        <div class="result-row"><span class="result-key">Chain Status</span><span class="result-val status-badge" id="res-cust-status">—</span></div>

        <!-- Journey timeline from local ledger -->
        <div class="journey-block hidden" id="cust-journey-wrap">
          <div class="journey-label">Blockchain Journey</div>
          <div class="timeline" id="cust-timeline"></div>
        </div>

        <!-- AI Graph if available -->
        <div class="journey-block hidden" id="cust-ai-graph">
          <div class="journey-label">AI Supply Chain Graph</div>
          <img id="cust-graph-img" src="" alt="Journey" class="journey-img">
        </div>
      </div>

    </div>`;
  },

  init_customer(){
    $('cust-form').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const f=e.target;
      const id=f.medicine_id.value.trim();
      const loc=f.location.value.trim()||'0,0';

      setLoading('cust-btn',true);
      $('cust-result').classList.add('hidden');
      $('cust-journey-wrap').classList.add('hidden');
      $('cust-ai-graph').classList.add('hidden');

      try{
        const data=await apiPost('/api/verify',{medicine_id:id,location:loc});

        const banner=$('cust-banner'),icon=$('cust-icon'),txt=$('cust-text');
        if(data.status==='verified'){
          banner.className='auth-verdict-banner auth-verified'; icon.textContent='&#10003;'; txt.textContent='AUTHENTIC';
        } else if(data.status==='fake'){
          banner.className='auth-verdict-banner auth-fake'; icon.textContent='&#10007;'; txt.textContent='COUNTERFEIT';
        } else {
          banner.className='auth-verdict-banner auth-error'; icon.textContent='!'; txt.textContent='VERIFY ERROR';
        }

        const bc=data.blockchain_data||{};
        $('res-cust-name').textContent=bc.name||'—';
        $('res-cust-loc').textContent=bc.current_location||'—';
        renderStatusBadge($('res-cust-status'),bc.status_code);

        // Build timeline from history
        if(data.history?.length){
          const tl=$('cust-timeline'); tl.innerHTML='';
          const dotMap={Factory:'',Distributor:'amber',Pharmacy:'violet',customer:'slate'};
          data.history.forEach(h=>{
            const dc=dotMap[h.role]||'';
            tl.innerHTML+=`
              <div class="timeline-item">
                <div class="timeline-dot ${dc}"></div>
                <div class="timeline-role">${h.role||'—'}</div>
                <div class="timeline-action">${h.role==='Factory'?'Batch Manufactured':h.role==='Distributor'?'In Transit':h.role==='Pharmacy'?'At Pharmacy':'Delivered'}</div>
                <div class="timeline-detail">Location: ${h.location||'—'} &nbsp;|&nbsp; Risk: <span class="risk-pill ${getRisk(parseFloat(h.risk_score)||0).cls}">${(parseFloat(h.risk_score)||0).toFixed(4)}</span></div>
                <div class="timeline-date">${fmtTimestamp(h.timestamp)}</div>
              </div>`;
          });
          $('cust-journey-wrap').classList.remove('hidden');
        }

        if(data.graph_url){
          const g=$('cust-graph-img');
          g.src=`${API_BASE}${data.graph_url}`;
          g.onerror=()=>$('cust-ai-graph').classList.add('hidden');
          $('cust-ai-graph').classList.remove('hidden');
        }

        $('cust-result').classList.remove('hidden');
        showToast(data.status==='verified'?'Product is AUTHENTIC':'ALERT: Product may be counterfeit', data.status==='verified'?'success':'error');

      }catch(err){
        showToast(`Error: ${err.message}`,'error'); console.error('[Customer]',err);
      }finally{ setLoading('cust-btn',false); }
    });
  },

  /* ─── SHARED: batch lookup helper ─── */
  lookupBatch(inputId, infoId){
    const id=$(inputId)?.value.trim();
    const wrap=$(infoId);
    const content=$(infoId+'-content');
    if(!id||!wrap||!content){return;}
    const rec=this.findBatch(id);
    if(!rec){ wrap.classList.add('hidden'); showToast('Not found in local ledger.','warning'); return; }
    const s=STATUS_MAP[rec.statusCode]??{label:'UNKNOWN',cls:'status-unknown'};
    content.innerHTML=`
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div style="font-family:var(--font-mono);font-size:.7rem;color:var(--text-secondary)">Name: <span style="color:var(--text-primary)">${rec.name||'—'}</span></div>
        <div style="font-family:var(--font-mono);font-size:.7rem;color:var(--text-secondary)">Weight: <span style="color:var(--text-primary)">${rec.weight||'—'} g</span></div>
        <div style="font-family:var(--font-mono);font-size:.7rem;color:var(--text-secondary)">Owner: <span style="color:var(--text-primary)">${rec.owner||'—'}</span></div>
        <div>Status: <span class="status-badge ${s.cls}" style="font-size:.58rem">${s.label}</span></div>
      </div>`;
    wrap.classList.remove('hidden');
  },
};

/* ─────────────────────────────────────────
   BACKEND STATUS CHECK
───────────────────────────────────────── */
async function checkBackend(){
  const dot=$('chain-dot'), label=$('chain-label');
  try{
    await fetch(`${API_BASE}/docs`,{method:'HEAD',mode:'no-cors'});
    dot.className='status-dot dot-online'; label.textContent='SEPOLIA · ONLINE';
  }catch{
    dot.className='status-dot dot-offline'; label.textContent='BACKEND OFFLINE';
  }
}
checkBackend();
setInterval(checkBackend,30000);

/* ─────────────────────────────────────────
   TICKER CLONE (seamless loop)
───────────────────────────────────────── */
(()=>{
  const track=document.querySelector('.ticker-track');
  if(!track)return;
  document.querySelectorAll('.ticker-item').forEach(i=>track.appendChild(i.cloneNode(true)));
})();

/* ─────────────────────────────────────────
   SCAN LINE KEYFRAME (customer view)
───────────────────────────────────────── */
const sl=document.createElement('style');
sl.textContent=`@keyframes scan-line{0%{top:0;opacity:0;}10%{opacity:1;}90%{opacity:1;}100%{top:100%;opacity:0;}}`;
document.head.appendChild(sl);

/* ─────────────────────────────────────────
   ROLE NAV WIRING
───────────────────────────────────────── */
document.querySelectorAll('.role-btn').forEach(btn=>{
  btn.addEventListener('click',()=>PC.setRole(btn.dataset.role));
});

/* ─────────────────────────────────────────
   BOOT
───────────────────────────────────────── */
PC.renderLedger();
PC.renderView();

document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    document.querySelectorAll('.result-card').forEach(c=>c.classList.add('hidden'));
  }
});
</script>
</body>
</html>